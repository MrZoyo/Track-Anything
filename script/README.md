# 桌面分割工具

这个工具使用 Segment Anything Model (SAM) 来从图片中分割出桌面区域。

## 功能特点

- **网格坐标系显示**：图片带网格线，方便查看坐标位置
- **手动输入坐标**：直接在代码中输入点坐标，简单可靠
- **支持正负样本**：可以添加正样本点（想要的区域）和负样本点（不想要的区域）
- **点的可视化**：在图片上显示你输入的点位置
- **多种可视化结果**：显示原图、二值化掩码、叠加效果和提取区域
- **自动保存结果**：保存掩码和可视化图片到 output 目录

## 使用方法

### 1. 环境准备

确保已经安装了项目的依赖：

```bash
cd /home/zoyo/Desktop/Track-Anything
pip install -r requirements.txt
```

### 2. 下载模型

确保 SAM 模型检查点已下载到 `checkpoints` 目录：
- 默认使用 `sam_vit_h_4b8939.pth`
- 如果没有，运行主程序 `app.py` 会自动下载

### 3. 启动 Jupyter Notebook

```bash
cd script
jupyter notebook table_segmentation.ipynb
```

### 4. 使用步骤

#### 步骤 1：修改图片路径
在 Cell 4 中修改 `IMAGE_PATH` 变量为你的桌子图片路径：
```python
IMAGE_PATH = '/path/to/your/table_image.jpg'
```

#### 步骤 2：运行前5个单元格
按顺序执行前5个单元格，这将：
- 导入必要的库
- 加载 SAM 模型
- 读取图片
- 显示带网格的图片

#### 步骤 3：查看网格图片，记录坐标
在显示的图片上查看网格和坐标轴，记录桌面区域的坐标点。

#### 步骤 4：输入坐标点
在 Cell 6 中修改 `points` 和 `labels` 列表：

```python
# 输入坐标点
points = [
    [230, 170],  # 点 1：桌子中心
    [150, 120],  # 点 2：桌子左侧
    [310, 210],  # 点 3：桌子右侧
]

# 每个点的标签（1 = 正样本，0 = 负样本）
labels = [
    1,  # 点 1 是正样本（在桌子上）
    1,  # 点 2 是正样本（在桌子上）
    1,  # 点 3 是正样本（在桌子上）
]
```

**说明：**
- `points`：坐标列表，格式为 `[x, y]`，x 是横坐标，y 是纵坐标
- `labels`：每个点的标签，1 表示正样本（桌面），0 表示负样本（背景）
- 建议在桌面的不同位置选择 2-5 个点

#### 步骤 5：运行后续单元格
依次执行剩余的单元格：
- Cell 6：显示你选择的点
- Cell 7：执行分割
- Cell 8：查看可视化结果
- Cell 9：保存结果到 output 目录

## 输出文件

所有结果保存在 `script/output` 目录：

- **table_mask.png**：二值化掩码图片（白色=桌面，黑色=背景）
- **table_mask.npy**：掩码 numpy 数组，可用于进一步处理
- **table_overlay.png**：掩码叠加在原图上（绿色高亮显示桌面）
- **table_extracted.png**：提取的桌面区域（白色背景）

## 使用技巧

### 1. 提高分割精度
- 在桌面的不同位置（左、中、右，或上、中、下）点击多个点
- 如果包含了不想要的区域，添加负样本点（label=0）来排除

### 2. 选择合适的点数量
- **简单场景**：桌面颜色均匀、边界清晰，2-3 个点即可
- **复杂场景**：桌面有多种颜色或纹理，建议 4-5 个点
- **有干扰物**：如果有不想要的区域，添加负样本点

### 3. 使用网格定位
- 主网格线（黄色虚线）间隔 50 像素
- 次网格线（浅色点线）间隔 10 像素
- 坐标轴显示精确的像素位置

### 4. 重新分割
如果分割效果不满意：
1. 运行 Cell 10（重置单元格）
2. 回到 Cell 6 修改点坐标
3. 重新运行 Cell 6-9

## 示例

### 示例 1：简单桌面分割
```python
# 在桌面中心选择 3 个点
points = [
    [200, 150],  # 中心点
    [300, 200],  # 右侧点
    [250, 180],  # 上方点
]
labels = [1, 1, 1]  # 全部是正样本
```

### 示例 2：带负样本点排除背景
```python
# 3 个桌面点 + 1 个背景点
points = [
    [200, 150],  # 桌面中心
    [300, 200],  # 桌面右侧
    [250, 180],  # 桌面上方
    [50, 50],    # 背景区域（要排除）
]
labels = [1, 1, 1, 0]  # 最后一个是负样本
```

### 示例 3：复杂桌面（多个点）
```python
# 在桌面不同区域选择 5 个点
points = [
    [230, 170],  # 中心
    [150, 120],  # 左上
    [310, 210],  # 右下
    [280, 130],  # 右上
    [180, 200],  # 左下
]
labels = [1, 1, 1, 1, 1]  # 全部是正样本
```

## 工作流程图

```
1. 加载图片
   ↓
2. 显示带网格的图片
   ↓
3. 查看坐标，记录桌面位置
   ↓
4. 在代码中输入坐标点
   ↓
5. 可视化输入的点
   ↓
6. 执行 SAM 分割
   ↓
7. 显示分割结果
   ↓
8. 保存输出文件
```

## 技术细节

### 模型信息
- **模型名称**：Segment Anything Model (SAM)
- **模型类型**：ViT-H（默认，最准确但最慢）
  - 可选：ViT-B（最快）、ViT-L（平衡）
- **设备**：自动检测 CUDA（GPU）或使用 CPU

### 输入格式
- **点坐标**：`[[x1, y1], [x2, y2], ...]`
- **点标签**：`[label1, label2, ...]`
  - `1`：正样本（想要分割的区域）
  - `0`：负样本（不想要的区域）

### 输出格式
- **掩码类型**：二值化 numpy 数组
- **掩码形状**：`[H, W]`（与输入图片相同）
- **掩码值**：
  - `True/1`：桌面区域
  - `False/0`：背景区域

## 常见问题

### Q: 模型加载失败？
**A:**
1. 检查 SAM 检查点路径是否正确
2. 确保文件存在于 `checkpoints` 目录
3. 如果文件不存在，运行 `python app.py` 会自动下载

### Q: CUDA out of memory（显存不足）？
**A:**
1. 修改设备为 CPU：`DEVICE = 'cpu'`
2. 或使用较小的模型：`MODEL_TYPE = 'vit_b'`

### Q: 分割效果不好？
**A:**
1. 添加更多的正样本点（在桌面不同位置）
2. 使用负样本点排除不想要的区域
3. 确保点确实在桌面上，而不是背景或其他物体上
4. 如果桌面有多种颜色或纹理，增加点的数量

### Q: 如何知道点的准确坐标？
**A:**
1. 查看网格图片，主网格线标注了坐标值
2. 鼠标悬停在图片上，部分 IDE 会显示坐标
3. 可以先输入大概的坐标，然后根据可视化结果调整

### Q: 保存的图片在哪里？
**A:** 所有结果保存在 `script/output/` 目录下。如果目录不存在，会自动创建。

### Q: 可以批量处理多张图片吗？
**A:** 当前版本是单张图片处理。如需批量处理，可以：
1. 复制 Cell 4-9 的代码
2. 添加循环遍历多张图片
3. 每张图片使用不同的坐标点

## 项目结构

```
script/
├── table_segmentation.ipynb  # 主 notebook
├── README.md                  # 本文件（使用说明）
└── output/                    # 输出目录（自动创建）
    ├── table_mask.png        # 二值化掩码
    ├── table_mask.npy        # numpy 数组
    ├── table_overlay.png     # 叠加效果图
    └── table_extracted.png   # 提取的桌面区域
```

## 依赖的项目文件

- `tools/base_segmenter.py`：SAM 分割器封装
- `checkpoints/sam_vit_h_4b8939.pth`：SAM 模型权重（约 2.5 GB）

## 性能参考

| 模型类型 | 精度 | 速度 | 显存占用 |
|---------|------|------|---------|
| vit_h   | 最高 | 最慢 | ~7 GB   |
| vit_l   | 中等 | 中等 | ~4 GB   |
| vit_b   | 较低 | 最快 | ~2 GB   |